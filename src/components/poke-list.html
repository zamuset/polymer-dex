<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="poke-card.html">
<dom-module id="poke-list">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <iron-ajax
            auto
            url="http://localhost:3000/pokemons"
            handle-as="json"
            on-response="_onLoadPokemnons"
            on-error="_handleError">
        </iron-ajax>
        <slot name="title" class="title" ></slot>
        <template is="dom-repeat" items="{{pokemons}}" 
        as="pokemon" 
        filter="{{_pokemonFilter(filter)}}"
        observe="captured">
            <poke-card pokemon="{{pokemon}}" on-click="_capture" on-pokemons-changed="_pokemonsChanged"></poke-card>
        </template>
    </template>
    <script>
        class PokeList extends Polymer.Element {
            constructor() {
                super()
                this.addEventListener("pokemons-changed", this._pokemonsChanged)
            }
            static get properties () {
                return {
                    filter: {
                        type: String
                    },
                    pokemons: {
                        type: Array,
                        value: [],
                        readOnly: true,
                        notify: true
                    }
                }
            }
            static get is () {
                return 'poke-list'
            }

            _capture (event) {
                event.model.set('pokemon.captured', true)
            }
            _onLoadPokemnons(event){
                this._setPokemons(event.detail.response)
            }
            _handleError(event){
                console.error("Error", event.detail)
            }
            _pokemonsChanged(event) {
                console.log(event)
            }
           /* _loadPokemnons() {
                fetch("http://localhost:3000/pokemons")
                    .then((response)=> response.json())
                    .then((response) => {
                        this.pokemons = response
                    })
                    .catch(console.error)

            }*/

            _pokemonFilter (filter) {
                console.log("poke-list", filter.search)
                console.log("poke-list", filter.captured)

                if(!filter.search && !filter.captured){
                    return null
                }
                return function(pokemon){
                    if(filter.captured){
                        return pokemon.captured && pokemon.name.indexOf(filter.search)>-1;
                    }else{
                        return pokemon.name.indexOf(filter.search)>-1;
                    }
                }
            }

            _pokemonFilter2 (filter) {
                return function(pokemon) {
                    if (filter.captured) {
                        return !pokemon.captured && pokemon.name.indexOf(filter)>-1;
                    } else {
                        return pokemon.name.indexOf(filter) > -1
                    }
                }
            }

          /*const index = event.model.index
          const path = 'pokemons.' + index + '.captured'
          console.log(path)
          this.set(path, true)*/

        //   console.log(pokemon)
        //   return !pokemon.captured
      }
        customElements.define(PokeList.is, PokeList)
    </script>
</dom-module>